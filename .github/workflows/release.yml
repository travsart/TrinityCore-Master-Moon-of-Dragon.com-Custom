name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        default: false
        type: boolean
      draft:
        description: 'Create as draft release'
        required: false
        default: false
        type: boolean

env:
  CMAKE_BUILD_TYPE: Release

jobs:
  # ===========================================================================
  # Build for all platforms in parallel
  # ===========================================================================
  build-linux:
    name: Build Linux x64
    runs-on: ubuntu-24.04
    timeout-minutes: 60

    outputs:
      artifact-name: ${{ steps.artifact.outputs.name }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          submodules: recursive

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> "$GITHUB_OUTPUT"
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> "$GITHUB_OUTPUT"
          fi

      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get install -yq \
            libboost-dev \
            libboost-filesystem-dev \
            libboost-locale-dev \
            libboost-program-options-dev \
            libboost-regex-dev \
            libboost-thread-dev \
            libssl-dev \
            libreadline-dev \
            zlib1g-dev \
            libbz2-dev \
            libmysqlclient-dev

      - name: Configure CMake
        env:
          CC: /usr/bin/gcc-13
          CXX: /usr/bin/g++-13
        run: |
          cmake -GNinja -S . -B build \
            -DCMAKE_BUILD_TYPE=${{ env.CMAKE_BUILD_TYPE }} \
            -DWITH_WARNINGS=0 \
            -DBUILD_PLAYERBOT=ON \
            -DTOOLS=1 \
            -DSCRIPTS=static \
            -DSERVERS=1 \
            -DCMAKE_INSTALL_PREFIX=release/install

      - name: Build
        run: cmake --build build

      - name: Install
        run: cmake --install build

      - name: Create release package
        id: artifact
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          ARTIFACT_NAME="TrinityCore-Playerbot-$VERSION-Linux-x64"
          echo "name=$ARTIFACT_NAME" >> "$GITHUB_OUTPUT"

          cd release
          mv install "$ARTIFACT_NAME"
          tar -czvf "$ARTIFACT_NAME.tar.gz" "$ARTIFACT_NAME"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.artifact.outputs.name }}
          path: release/*.tar.gz
          retention-days: 30

  # ===========================================================================
  # Create GitHub Release
  # ===========================================================================
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-linux]
    timeout-minutes: 15

    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> "$GITHUB_OUTPUT"
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> "$GITHUB_OUTPUT"
          fi

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Generate release notes
        id: release-notes
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Get commits since last tag
          LAST_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -n "$LAST_TAG" ]; then
            COMMITS=$(git log --oneline "$LAST_TAG"..HEAD | head -50)
          else
            COMMITS=$(git log --oneline -50)
          fi

          cat > release_notes.md << EOF
          # TrinityCore with Playerbot Integration $VERSION

          ## Downloads

          | Platform | Architecture | File |
          |----------|--------------|------|
          | Windows | x64 | TrinityCore-Playerbot-$VERSION-Windows-x64.zip |
          | Linux | x64 | TrinityCore-Playerbot-$VERSION-Linux-x64.tar.gz |
          | macOS | arm64 | TrinityCore-Playerbot-$VERSION-macOS-arm64.tar.gz |

          ## Features

          This release includes the Playerbot module for AI-controlled player bots, enabling:
          - Single-player MMORPG experience
          - AI party members for dungeons and raids
          - Configurable bot behavior and strategies

          ## Requirements

          - MySQL 8.0+
          - TrinityCore compatible data files
          - Platform-specific runtime libraries (included in Windows build)

          ## Recent Changes

          \`\`\`
          $COMMITS
          \`\`\`

          ## Installation

          1. Extract the archive for your platform
          2. Configure worldserver.conf and bnetserver.conf
          3. Set up the database using provided SQL files
          4. Start bnetserver and worldserver

          For detailed instructions, see the [documentation](../../wiki).

          ---

          **Build Information:**
          - Commit: ${{ github.sha }}
          - Branch: ${{ github.ref_name }}
          - Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: TrinityCore Playerbot ${{ steps.version.outputs.version }}
          body_path: release_notes.md
          draft: ${{ github.event.inputs.draft || false }}
          prerelease: ${{ github.event.inputs.prerelease || false }}
          files: |
            artifacts/${{ needs.build-linux.outputs.artifact-name }}/*.tar.gz
          fail_on_unmatched_files: false

      - name: Notify release success
        run: |
          echo "Release ${{ steps.version.outputs.version }} created successfully!"
          echo "Downloads available for Windows x64, Linux x64, and macOS arm64"

# ==============================================================================
# Summary
# ==============================================================================
# This release workflow provides automated multi-platform releases:
#
# Triggers:
# - Push of version tags (v*)
# - Manual workflow_dispatch with version input
#
# Builds:
# - Linux x64 (GCC 13)
#
# Release includes:
# - Pre-built binaries for all platforms
# - Auto-generated release notes with recent commits
# - Installation instructions
#
# Manual Release:
#   gh workflow run release.yml -f version=v1.0.0 -f prerelease=false
#
# Tag Release:
#   git tag v1.0.0 && git push origin v1.0.0
# ==============================================================================
